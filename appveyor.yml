version: "{build}"

# comment out this line, once this is merged to main Vim
skip_tags: true

environment:
  matrix:
    - ARCH: x64
    - ARCH: x86

matrix:
  fast_finish: true

shallow_clone: true

build:
  verbosity: minimal

before_build:
  - '"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.cmd" /%ARCH% /release'
  - src\appveyor.bat install

build_script:
  - cd src
  - appveyor.bat build
  - .\gvim -silent -register
  - .\gvim -u NONE -c "redir @a | ver | 0put a | wq!" ver.txt
  - type ver.txt
  - .\vim --version

after_build:
  - copy /Y *.exe ..\runtime\
  - copy /Y xxd\*.exe ..\runtime
  - mkdir ..\runtime\GvimExt
  - copy /Y GvimExt\gvimext.dll ..\runtime\GvimExt\
  - copy /Y GvimExt\README.txt  ..\runtime\GvimExt\
  - copy /Y GvimExt\*.inf       ..\runtime\GvimExt\
  - copy /Y GvimExt\*.reg       ..\runtime\GvimExt\
  - copy /Y c:\projects\diff.exe ..\runtime\
  - copy /Y c:\gettext\libiconv*.dll ..\runtime\
  - copy /Y c:\gettext\libintl.dll ..\runtime\
  # libwinpthread is needed on Win64 for localizing messages
  - if exist c:\gettext\libwinpthread-1.dll copy /Y c:\gettext\libwinpthread-1.dll ..\runtime\
  - 7z a ..\gvim_%ARCH%.zip ..\runtime\*

test_script:
  - cd testdir
  - nmake -f Make_dos.mak VIMPROG=..\gvim
  - nmake -f Make_dos.mak clean
  - nmake -f Make_dos.mak VIMPROG=..\vim

artifacts:
  - path: gvim_x86.zip
    name: gVim_x86
  - path: gvim_x64.zip
    name: gVim_x64

deploy:
  - provider: GitHub
    release: vim-$(APPVEYOR_REPO_COMMIT)
    # uncomment next lines, when this is merged to Vim mainline
    #release: vim-$(APPVEYOR_REPO_TAG_NAME)
    description: 'Nightly Vim Windows build snapshots'
    auth_token:
      secure: kH0D/3t+1Mc8OChKhe+voKlMO0aMwnlUr64QoZOJC6BaVwy+Us3ZHq9Oo+aBzjYc
    artifact: /gVim/
    draft: false
    prerelease: false
#   uncomment the following lines, once this is merged to Vim main repository:
    on:
      appveyor_repo_tag: true
